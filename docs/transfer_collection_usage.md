# 平库移库功能使用说明

本文档概述 Flutter 平库移库采集页面的主要操作流程、关键校验以及测试覆盖情况，供研发与业务同事快速了解新模块。

## 1. 页面入口与前置条件
- 在首页“平库移库”入口点击后进入 `/transfer` 路由，由 `TransferModule` 注册。
- 默认以“移出”模式加载，需先确认登录账号具备移库权限，并已同步仓库主数据。

## 2. 扫描采集流程
1. **来源库位**：扫描 `$KW$` 库位条码，系统调用 `TransferTaskService.validateStoreSite` 校验库位是否存在、是否冻结，并同步库房信息。
2. **目标库位**：继续扫描目标库位条码，重复库位校验，并在通过后写入 ERP 子库字段。
3. **物料条码**：扫描物料二维码，调用 `/system/terminal/getPmMaterialInfoByQR` 解析物料、批次/序列、项目号等信息，同时拉取来源/目标组合库存。
4. **数量输入**：根据控制模式输入或确认数量，系统校验：
   - 库存是否充足（含批次/序列、项目号维度）。
   - 序列号是否重复采集。
   - 采集数量会累计到 `quantityDict`，便于后续扣减。
5. **提交**：采集完成后点击“提交”，将勾选的采集明细组装为 `TransferSubmitPayload`，通过 `GoodsUpTaskService.commitTransfer` 下发后端。

## 3. 常见提示与异常处理
- 库位不存在或冻结：提示“库位不存在/已冻结”，阻断流程。
- 物料条码缺失关键信息：提示“条码未包含物料信息”。
- 库存不足：提示剩余可用数量并阻止录入。
- 序列号重复：提示“序列号已采集，请勿重复录入”。
- 无采集数据提交：提交按钮触发 `CollectionStatus.error("当前无采集数据")`。

## 4. 测试覆盖
- `transfer_task_service_test.dart`：验证库位校验、物料解析、库存查询及转储提交请求体构造。
- `transfer_collection_bloc_test.dart`：覆盖初始化、库位扫描、数量采集成功/失败分支，以及提交后的状态重置与载荷校验。

## 5. 后续建议
- 结合真实设备扫码进行端到端演练，确保二维码解析格式与生产一致。
- 继续补充 Widget 测试覆盖 UI Tab 切换、删除、模式切换等交互。
